<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wrexham Harvard Referencing Tool (June 2024)</title>
  <meta name="description" content="Wrexham Harvard Referencing Tool aligned to the June 2024 guide. Import DOI/URL/PDF, build libraries, export to Word, and share with classmates." />

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.min.js"></script>

  <style>
    :root{
      --bg:#070a10;
      --card:#0f1726;
      --panel:#0b1322;
      --text:#eaf0ff;
      --muted:#9aa8c7;
      --line:#223049;
      --brand:#2f7cff;
      --brand2:#7c3aed;
      --danger:#ef4444;
      --ok:#22c55e;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:radial-gradient(900px 600px at 20% 0%, rgba(47,124,255,.22), transparent 60%),
                 radial-gradient(900px 600px at 80% 10%, rgba(124,58,237,.18), transparent 60%),
                 linear-gradient(180deg,#070a10,#05070c);
      color:var(--text);
    }
    header{
      position:sticky;top:0;z-index:10;
      background:rgba(7,10,16,.72);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(34,48,73,.85);
    }
    .wrap{max-width:1300px;margin:0 auto;padding:0 12px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
      padding:12px 0;
    }
    .logo{display:flex;align-items:center;gap:10px}
    .mark{
      width:34px;height:34px;border-radius:10px;
      background:linear-gradient(135deg,var(--brand),var(--brand2));
      box-shadow:0 14px 40px rgba(47,124,255,.22);
    }
    .logo b{font-size:14px}
    .small{font-size:12px;color:var(--muted)}
    .nav{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:12px;
      border:1px solid rgba(34,48,73,.9);
      background:#0b1322;color:var(--text);
      text-decoration:none;font-size:13px;
      cursor:pointer;
    }
    .btn.primary{
      background:linear-gradient(135deg, rgba(47,124,255,.95), rgba(124,58,237,.85));
      border-color:transparent;
    }
    .btn.danger{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35)}
    .btn.ghost{background:transparent}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .pill{
      display:inline-block;font-size:12px;color:var(--muted);
      border:1px solid rgba(34,48,73,.9);
      background:#0a1220;padding:5px 10px;border-radius:999px
    }
    .status{font-size:12px;color:var(--muted)}
    .status.ok{color:var(--ok)}
    .status.warn{color:#ffd18a}
    .status.bad{color:#fca5a5}

    main{max-width:1300px;margin:0 auto;padding:12px}
    .landing{
      display:grid;grid-template-columns: 1.15fr .85fr;gap:12px;align-items:start;
    }
    @media (max-width: 980px){ .landing{grid-template-columns:1fr} }

    .appgrid{
      display:grid;grid-template-columns: 520px 1fr;gap:12px;align-items:start;
    }
    @media (max-width: 1080px){ .appgrid{grid-template-columns:1fr} }

    .card{
      background:rgba(15,23,38,.9);
      border:1px solid rgba(34,48,73,.9);
      border-radius:16px;
      padding:12px;
    }
    h1{margin:0 0 8px;font-size:32px;line-height:1.15}
    h2{margin:0 0 8px;font-size:16px}
    h3{margin:0 0 6px;font-size:14px}
    p{margin:0 0 10px;color:var(--muted);line-height:1.5}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    @media (max-width: 740px){ .row,.row3{grid-template-columns:1fr} }

    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select,textarea{
      width:100%;padding:10px 12px;border-radius:12px;
      border:1px solid rgba(34,48,73,.95);
      background:#0a1220;color:var(--text);outline:none;
    }
    textarea{min-height:70px;resize:vertical}
    .out{
      background:#08101d;
      border:1px dashed rgba(42,59,89,.95);
      border-radius:12px;
      padding:10px 12px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      font-size:12px;
      white-space:pre-wrap;
    }
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .divider{height:1px;background:rgba(34,48,73,.8);margin:12px 0}
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .toolbar .left,.toolbar .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    .drop{
      border:1px dashed rgba(42,59,89,.95);
      border-radius:14px;
      padding:12px;
      background:#08101d;
      display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    }
    .drop.drag{border-color:var(--brand);background:rgba(47,124,255,.08)}
    .list{display:grid;gap:10px;margin-top:10px}
    .item{
      background:#0a1220;
      border:1px solid rgba(34,48,73,.9);
      border-radius:14px;
      padding:12px;
    }
    .item h4{margin:0;font-size:14px}
    .meta{margin-top:6px;color:var(--muted);font-size:12px;display:flex;gap:8px;flex-wrap:wrap}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .actions .btn{padding:8px 10px;font-size:12px}

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tab{
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(34,48,73,.9);
      background:#0a1220;color:var(--muted);
      cursor:pointer;font-size:12px;
    }
    .tab.active{background:#152748;color:var(--text);border-color:#27457f}

    .hide{display:none!important}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .chip{
      font-size:12px;color:var(--muted);
      border:1px solid rgba(34,48,73,.9);
      background:#0a1220;padding:6px 10px;border-radius:999px
    }
  </style>
</head>

<body>
<header>
  <div class="wrap top">
    <div class="logo">
      <div class="mark"></div>
      <div>
        <b>Wrexham Harvard Referencing Tool</b>
        <div class="small">Aligned to the Wrexham Harvard guide (June 2024)</div>
      </div>
    </div>

    <div class="nav">
      <span class="status" id="authStatus">Cloud: off (local only)</span>
      <button class="btn primary" id="signInBtn" type="button">Sign in</button>
      <button class="btn" id="signOutBtn" type="button" disabled>Sign out</button>
      <button class="btn ghost" id="openToolBtn" type="button">Open tool</button>
    </div>
  </div>
</header>

<main>
  <!-- LANDING -->
  <section id="landing" class="landing">
    <div class="card">
      <h1>Wrexham Harvard references that match your guide — fast.</h1>
      <p>Import DOI/URL/PDF, generate in-text + reference list entries, export to Word, and keep everything in tidy libraries. Optional sign-in adds cloud save and share links for group work.</p>
      <div class="chips">
        <span class="chip">Wrexham punctuation & structure</span>
        <span class="chip">[Accessed 16th December, 2023.] format</span>
        <span class="chip">Vol. / No. / pp.</span>
        <span class="chip">Secondary citations + a/b/c</span>
        <span class="chip">PDF drag & drop</span>
        <span class="chip">Word export</span>
      </div>

      <div class="actions" style="margin-top:12px">
        <button class="btn primary" id="startBtn" type="button">Start referencing</button>
        <button class="btn" id="scrollCloudBtn" type="button">Turn on cloud save</button>
      </div>

      <div class="hint" style="margin-top:10px">
        Independent tool (not affiliated with Wrexham University). Always follow module instructions if they differ.
      </div>
    </div>

    <div class="card" id="cloudSetup">
      <h2>Cloud save + sharing (optional)</h2>
      <p>To enable login + cloud libraries + share links, paste your Firebase web config below. If you don’t, the tool still works fully offline and remains 100% Wrexham-formatted.</p>

      <label>Firebase config (paste JSON object)</label>
      <textarea id="firebaseConfigBox" placeholder='{
  "apiKey": "...",
  "authDomain": "...",
  "projectId": "...",
  "appId": "...",
  "storageBucket": "...",
  "messagingSenderId": "..."
}'></textarea>

      <div class="actions">
        <button class="btn primary" id="enableCloudBtn" type="button">Enable cloud</button>
        <button class="btn" id="clearCloudBtn" type="button">Keep local only</button>
      </div>

      <div class="hint">
        In Firebase: enable Google sign-in + add <b>angelsds202-oss.github.io</b> to Authorized domains.
      </div>
    </div>
  </section>

  <!-- APP -->
  <section id="app" class="appgrid hide">
    <!-- LEFT: Editor -->
    <section class="card">
      <div class="toolbar">
        <div class="left">
          <span class="pill" id="modePill">Mode: Add</span>
          <span class="pill" id="savePill">Storage: Local</span>
        </div>
        <div class="right">
          <button class="btn" id="newBtn" type="button">New</button>
        </div>
      </div>

      <label>Library</label>
      <div class="row">
        <select id="librarySelect"></select>
        <button class="btn" id="newLibraryBtn" type="button">New library</button>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn danger" id="deleteLibraryBtn" type="button">Delete library</button>
        <button class="btn" id="syncBtn" type="button">Sync now</button>
      </div>
      <div class="hint">Signed in = cloud sync + share. Not signed in = device only.</div>

      <div class="divider"></div>

      <label>Quick Import (paste DOI / URL)</label>
      <div class="row">
        <input id="quickImport" placeholder="10.xxxx/xxxx or https://..." />
        <button class="btn primary" id="importBtn" type="button">Import</button>
      </div>
      <div class="hint" id="importStatus">Tip: DOI import gives best metadata; you can always edit fields after.</div>

      <label>PDF Import (drag & drop or click)</label>
      <div class="drop" id="dropZone">
        <div>
          <b>Drop a PDF here</b>
          <div class="hint" id="pdfStatus">PDF stays on your device. We extract metadata + scan page 1 for organisations.</div>
        </div>
        <div class="actions" style="margin:0">
          <input id="pdfInput" type="file" accept="application/pdf" style="display:none" />
          <button class="btn" id="pickPdfBtn" type="button">Choose PDF</button>
          <button class="btn danger" id="clearPdfBtn" type="button">Clear</button>
        </div>
      </div>

      <div class="divider"></div>

      <label>Category (Wrexham formats)</label>
      <select id="category">
        <option value="website">Internet / webpage</option>
        <option value="journal">Journal article</option>
        <option value="book">Book</option>
        <option value="chapter">Chapter in edited book</option>
        <option value="ebook">eBook (online)</option>
        <option value="lhb">Local Health Board policy (details withheld)</option>
        <option value="newspaper_print">Newspaper (print)</option>
        <option value="newspaper_online">Newspaper (online)</option>
        <option value="govpub">Government publication (online)</option>
        <option value="legislation">Legislation / Act (online)</option>
        <option value="lecture_recorded">Recorded lecture</option>
        <option value="lecture_live">Live lecture</option>
        <option value="handout">Tutor handout</option>
        <option value="ppt">PowerPoint presentation</option>
        <option value="thesis">Thesis (online)</option>
        <option value="personal_comm">Personal communication</option>
        <option value="image_online">Image (online)</option>
        <option value="image_location">Image (gallery/location)</option>
        <option value="other">Other (manual)</option>
      </select>

      <div class="row" style="margin-top:10px">
        <label style="margin:0;display:flex;align-items:center;gap:10px">
          <input type="checkbox" id="secondaryToggle" />
          Secondary reference (cited by)
        </label>
        <div class="hint" style="margin:0">Outputs: (Original, Year, cited by Source, Year)</div>
      </div>

      <div id="secondaryBox" class="hide">
        <div class="row">
          <div>
            <label>Original author / organisation</label>
            <input id="origAuthor" placeholder="e.g., Williams" />
          </div>
          <div>
            <label>Original year</label>
            <input id="origYear" placeholder="e.g., 2017" />
          </div>
        </div>
      </div>

      <label>Authors (multi-author supported)</label>
      <div id="authorsWrap" style="display:grid;gap:8px"></div>
      <div class="actions" style="margin-top:8px">
        <button class="btn" id="addAuthorBtn" type="button">+ Add author</button>
        <button class="btn" id="useOrgBtn" type="button">Use as organisation</button>
      </div>
      <div class="hint">Organisations are one “author” with no initials (e.g., NICE).</div>

      <div class="row3">
        <div>
          <label>Year</label>
          <input id="year" placeholder="e.g., 2024 or no date" />
        </div>
        <div>
          <label>Accessed day</label>
          <input id="accDay" placeholder="e.g., 16" />
        </div>
        <div>
          <label>Accessed month</label>
          <input id="accMonth" placeholder="e.g., December" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Accessed year</label>
          <input id="accYear" placeholder="e.g., 2023" />
        </div>
        <div>
          <label>In-text page (optional)</label>
          <input id="page" placeholder="e.g., p. 50" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Published day (optional)</label>
          <input id="pubDay" placeholder="e.g., 25" />
        </div>
        <div>
          <label>Published month (optional)</label>
          <input id="pubMonth" placeholder="e.g., May" />
        </div>
      </div>

      <label>Title</label>
      <input id="title" placeholder="Exact title" />

      <div class="row">
        <div>
          <label>Container (Journal / Book / Site / Module details)</label>
          <input id="container" placeholder="e.g., BMJ / The Guardian / AAA111: Mental Health" />
        </div>
        <div>
          <label>Publisher (books/reports) OR Institution</label>
          <input id="publisher" placeholder="e.g., Sage / Wrexham University" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Place (books)</label>
          <input id="place" placeholder="e.g., London" />
        </div>
        <div>
          <label>Edition (if not 1st)</label>
          <input id="edition" placeholder="e.g., 4th ed." />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Volume (journals)</label>
          <input id="volume" placeholder="e.g., 13" />
        </div>
        <div>
          <label>Issue / Part (journals)</label>
          <input id="issue" placeholder="e.g., 2" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Page range (articles/chapters)</label>
          <input id="pages" placeholder="e.g., 171-185" />
        </div>
        <div>
          <label>DOI (optional)</label>
          <input id="doi" placeholder="e.g., https://doi.org/..." />
        </div>
      </div>

      <div id="teachFields" class="hide">
        <div class="divider"></div>
        <div class="hint"><b>Teaching materials</b>: module + institution + date month (+ URL if recorded/PPT).</div>
        <div class="row">
          <div>
            <label>Medium</label>
            <select id="teachMedium">
              <option value="Lecture">Lecture</option>
              <option value="PowerPoint presentation">PowerPoint presentation</option>
            </select>
          </div>
          <div>
            <label>Date (day)</label>
            <input id="teachDay" placeholder="e.g., 13" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Date (month)</label>
            <input id="teachMonth" placeholder="e.g., January" />
          </div>
          <div>
            <label>Module code & title</label>
            <input id="teachModule" placeholder="e.g., AAA111: Mental Health" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Institution</label>
            <input id="teachInstitution" placeholder="e.g., Wrexham University" />
          </div>
          <div>
            <label>Unpublished? (handouts)</label>
            <select id="teachUnpub">
              <option value="no">No</option>
              <option value="yes">Yes (adds “Unpublished.”)</option>
            </select>
          </div>
        </div>
      </div>

      <div id="imageFields" class="hide">
        <div class="divider"></div>
        <div class="row">
          <div>
            <label>Image type</label>
            <input id="imgType" placeholder="e.g., Painting / Photograph / Diagram" />
          </div>
          <div>
            <label>Location (if gallery format)</label>
            <input id="imgLocation" placeholder="e.g., Liverpool: Walker Art Gallery" />
          </div>
        </div>
      </div>

      <label>URL (required for online categories)</label>
      <input id="url" placeholder="https://..." />

      <label>Notes</label>
      <textarea id="notes" placeholder="Key points, why used, etc."></textarea>

      <div class="actions">
        <button class="btn primary" id="generateBtn" type="button">Generate</button>
        <button class="btn primary" id="saveBtn" type="button" disabled>Save</button>
        <button class="btn" id="copyInBtn" type="button" disabled>Copy in-text</button>
        <button class="btn" id="copyRefBtn" type="button" disabled>Copy reference</button>
      </div>

      <label>Generated in-text citation</label>
      <div class="out" id="outIn">—</div>

      <label>Generated reference list entry</label>
      <div class="out" id="outRef">—</div>

      <div class="divider"></div>

      <div>
        <h3>Share with classmates</h3>
        <div class="hint">Create a share link for the current library (requires sign in + cloud enabled).</div>
        <div class="row">
          <select id="shareMode">
            <option value="view">View only</option>
            <option value="edit">Can edit (group work)</option>
          </select>
          <button class="btn primary" id="createShareBtn" type="button">Create share link</button>
        </div>
        <label>Share link</label>
        <div class="out" id="shareOut">—</div>
        <div class="actions">
          <button class="btn" id="copyShareBtn" type="button" disabled>Copy share link</button>
        </div>
      </div>
    </section>

    <!-- RIGHT: Library + Bib -->
    <section class="card">
      <div class="toolbar">
        <div class="left">
          <h2 style="margin:0">Library</h2>
          <span class="pill" id="countPill">0</span>
        </div>
        <div class="right">
          <button class="btn" id="exportCsvBtn" type="button">Export CSV</button>
          <button class="btn" id="exportTxtBtn" type="button">Export .txt</button>
          <button class="btn primary" id="exportDocBtn" type="button">Export Word .doc</button>
          <button class="btn danger" id="clearLibBtn" type="button">Clear library</button>
        </div>
      </div>

      <div class="tabs">
        <div class="tab active" data-tab="items">Items</div>
        <div class="tab" data-tab="bib">Reference list view</div>
      </div>

      <div id="panel-items">
        <div class="row" style="margin-top:10px">
          <input id="search" placeholder="Search by author, title, category..." />
          <select id="filterCat">
            <option value="all">All</option>
            <option value="website">Internet / webpage</option>
            <option value="journal">Journal</option>
            <option value="book">Book</option>
            <option value="chapter">Chapter</option>
            <option value="ebook">eBook</option>
            <option value="lhb">LHB policy</option>
            <option value="newspaper_print">Newspaper (print)</option>
            <option value="newspaper_online">Newspaper (online)</option>
            <option value="govpub">Government publication</option>
            <option value="legislation">Legislation</option>
            <option value="lecture_recorded">Recorded lecture</option>
            <option value="lecture_live">Live lecture</option>
            <option value="handout">Tutor handout</option>
            <option value="ppt">PowerPoint</option>
            <option value="thesis">Thesis</option>
            <option value="personal_comm">Personal comm</option>
            <option value="image_online">Image online</option>
            <option value="image_location">Image location</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="list" id="list"></div>
      </div>

      <div id="panel-bib" class="hide">
        <div class="hint">Alphabetical reference list (Wrexham format).</div>
        <div class="divider"></div>
        <div class="actions">
          <button class="btn" id="copyBibBtn" type="button">Copy full reference list</button>
          <button class="btn" id="copyBibWordBtn" type="button">Copy for Word (hanging indent)</button>
        </div>
        <label>Reference list</label>
        <div class="out" id="bibOut">—</div>
      </div>
    </section>
  </section>
</main>

<script>
/* ============================================================
   SINGLE-FILE FULL TOOL
   - Local works immediately
   - Cloud+share turns on when Firebase config is pasted
   ============================================================ */

const el = (id)=>document.getElementById(id);
const safe = (s)=>String(s||"").trim();

/* ---------- UI show/hide ---------- */
function showTool(){
  el("landing").classList.add("hide");
  el("app").classList.remove("hide");
  window.scrollTo({top:0,behavior:"smooth"});
}
el("startBtn").onclick = showTool;
el("openToolBtn").onclick = showTool;
el("scrollCloudBtn").onclick = ()=>el("cloudSetup").scrollIntoView({behavior:"smooth"});

/* ---------- Tabs ---------- */
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    const name = t.getAttribute("data-tab");
    if(name==="items"){
      el("panel-items").classList.remove("hide");
      el("panel-bib").classList.add("hide");
    } else {
      el("panel-items").classList.add("hide");
      el("panel-bib").classList.remove("hide");
      renderBib();
    }
  });
});

/* ============================================================
   WREXHAM DATE FORMATTERS
   Accessed: [Accessed 16th December, 2023.]
   ============================================================ */
const MONTHS = {
  jan:"January", january:"January",
  feb:"February", february:"February",
  mar:"March", march:"March",
  apr:"April", april:"April",
  may:"May",
  jun:"June", june:"June",
  jul:"July", july:"July",
  aug:"August", august:"August",
  sep:"September", sept:"September", september:"September",
  oct:"October", october:"October",
  nov:"November", november:"November",
  dec:"December", december:"December"
};
function normaliseMonth(m){
  const k = safe(m).toLowerCase().replace(/\./g,"");
  return MONTHS[k] || safe(m);
}
function ordinalDay(d){
  const s = safe(d);
  if(!s) return "";
  if(/\d+(st|nd|rd|th)$/i.test(s)) return s;
  const n = parseInt(s,10);
  if(!Number.isFinite(n)) return s;
  const mod100 = n % 100;
  const mod10 = n % 10;
  let suf = "th";
  if(mod100 < 11 || mod100 > 13){
    if(mod10 === 1) suf="st";
    else if(mod10 === 2) suf="nd";
    else if(mod10 === 3) suf="rd";
  }
  return `${n}${suf}`;
}
function accessedBracket(d,m,y){
  const dd = ordinalDay(d);
  const mm = normaliseMonth(m);
  const yy = safe(y);
  if(!dd || !mm || !yy) return "";
  return `[Accessed ${dd} ${mm}, ${yy}.]`;
}
function fillAccessedTodayIfBlank(){
  const d = new Date();
  if(!safe(el("accDay").value)) el("accDay").value = String(d.getDate());
  if(!safe(el("accMonth").value)) el("accMonth").value = d.toLocaleString("en-GB",{month:"long"});
  if(!safe(el("accYear").value)) el("accYear").value = String(d.getFullYear());
}

/* ============================================================
   AUTHORS (multi-author + organisation)
   ============================================================ */
let authorsState = [{name:"", initials:""}];

function renderAuthors(){
  const wrap = el("authorsWrap");
  wrap.innerHTML = "";
  if(!authorsState.length) authorsState = [{name:"", initials:""}];

  authorsState.forEach((a, idx)=>{
    const line = document.createElement("div");
    line.style.display="grid";
    line.style.gridTemplateColumns="1fr 140px 44px";
    line.style.gap="8px";
    line.style.alignItems="center";
    line.innerHTML = `
      <input data-k="name" data-i="${idx}" placeholder="Surname / Organisation (e.g., Smith / NICE)" value="${escapeHtml(a.name)}" />
      <input data-k="initials" data-i="${idx}" placeholder="Initials (e.g., A.B.)" value="${escapeHtml(a.initials)}" />
      <button class="btn danger" data-act="rm" data-i="${idx}" type="button" style="padding:8px 0">✕</button>
    `;
    wrap.appendChild(line);
  });

  wrap.querySelectorAll("input[data-k]").forEach(inp=>{
    inp.addEventListener("input", ()=>{
      const i = Number(inp.getAttribute("data-i"));
      const k = inp.getAttribute("data-k");
      authorsState[i][k] = inp.value;
    });
  });

  wrap.querySelectorAll("button[data-act='rm']").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const i = Number(btn.getAttribute("data-i"));
      authorsState.splice(i,1);
      if(!authorsState.length) authorsState = [{name:"", initials:""}];
      renderAuthors();
    });
  });
}
function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}
el("addAuthorBtn").onclick = ()=>{ authorsState.push({name:"",initials:""}); renderAuthors(); };
el("useOrgBtn").onclick = ()=>{
  const org = safe(authorsState[0]?.name);
  authorsState = [{name: org, initials:""}];
  renderAuthors();
};

function formatAuthorsReference(authors){
  const cleaned = (authors||[]).map(a=>({name:safe(a.name), initials:safe(a.initials)})).filter(a=>a.name);
  if(!cleaned.length) return "Unknown";
  const as = cleaned.map(a => a.initials ? `${a.name}, ${a.initials}` : a.name);
  if(as.length===1) return as[0];
  if(as.length===2) return `${as[0]} and ${as[1]}`;
  return `${as.slice(0,-1).join(", ")} and ${as[as.length-1]}`;
}
function formatAuthorsInText(authors){
  const cleaned = (authors||[]).map(a=>safe(a.name)).filter(Boolean);
  if(!cleaned.length) return "Unknown";
  if(cleaned.length===1) return cleaned[0];
  if(cleaned.length===2) return `${cleaned[0]} and ${cleaned[1]}`;
  return `${cleaned[0]} et al.`;
}
function authorsKey(authors){
  const cleaned = (authors||[]).map(a=>safe(a.name).toLowerCase()).filter(Boolean);
  return cleaned.length ? cleaned.join("|") : "unknown";
}

/* ============================================================
   STORAGE MODEL: Local libraries always.
   Optional cloud overlays when enabled.
   ============================================================ */
const KEY_PREFIX = "wrx_wu_lib_";
const LIBLIST_KEY = "wrx_wu_lib_list";
const CUR_LIB_KEY = "wrx_wu_cur_lib";

function sanitizeLibName(name){
  const n = safe(name).replace(/[^a-zA-Z0-9 _-]/g,"").trim().slice(0,40);
  return n || "My Library";
}
function getLibList(){
  try{return JSON.parse(localStorage.getItem(LIBLIST_KEY))||[];}catch{return[];}
}
function setLibList(list){ localStorage.setItem(LIBLIST_KEY, JSON.stringify(list)); }
function getCurrentLib(){ return sanitizeLibName(localStorage.getItem(CUR_LIB_KEY)||"My Library"); }
function setCurrentLib(name){ localStorage.setItem(CUR_LIB_KEY, sanitizeLibName(name)); }
function localKey(){ return KEY_PREFIX + getCurrentLib(); }
function loadLocalItems(){ try{return JSON.parse(localStorage.getItem(localKey()))||[];}catch{return[];} }
function saveLocalItems(items){ localStorage.setItem(localKey(), JSON.stringify(items)); }

function ensureLocalLib(){
  let libs = getLibList().map(sanitizeLibName).filter(Boolean);
  let cur = getCurrentLib();
  if(!libs.includes(cur)) libs.push(cur);
  if(!libs.length){ libs=["My Library"]; cur="My Library"; setCurrentLib(cur); }
  setLibList(libs);
  return cur;
}

/* ============================================================
   a/b/c suffix (same author + same year) – Wrexham compatible
   ============================================================ */
function computeYearSuffix(currentId, authors, year){
  const y = safe(year);
  if(!/^\d{4}$/.test(y)) return "";
  const key = authorsKey(authors);
  const items = getAllItems().filter(x=>x.id!==currentId)
    .filter(x=>safe(x.year)===y)
    .filter(x=>authorsKey(x.authors)===key);
  const used = new Set(items.map(i=>safe(i.yearSuffix)).filter(Boolean));
  // preserve existing if editing
  const cur = currentId ? getAllItems().find(x=>x.id===currentId) : null;
  if(cur && authorsKey(cur.authors)===key && safe(cur.year)===y && safe(cur.yearSuffix)) return safe(cur.yearSuffix);
  for(const l of "abcdefghijklmnopqrstuvwxyz"){ if(!used.has(l)) return l; }
  return "";
}

/* ============================================================
   CATEGORY VISIBILITY
   ============================================================ */
function updateConditionalFields(){
  const c = el("category").value;
  const showTeach = ["lecture_recorded","lecture_live","handout","ppt"].includes(c);
  const showImg = ["image_online","image_location"].includes(c);
  el("teachFields").classList.toggle("hide", !showTeach);
  el("imageFields").classList.toggle("hide", !showImg);

  if(["website","journal","ebook","govpub","legislation","newspaper_online","lecture_recorded","ppt","thesis","image_online"].includes(c)){
    fillAccessedTodayIfBlank();
  }
}
el("category").addEventListener("change", updateConditionalFields);

/* ============================================================
   SNAPSHOT FORM
   ============================================================ */
let editingId = null;

function snapshot(){
  const f = {
    id: editingId,
    category: el("category").value,
    year: el("year").value,
    yearSuffix: "",
    secondary: el("secondaryToggle").checked,
    origAuthor: el("origAuthor").value,
    origYear: el("origYear").value,
    authors: authorsState.map(a=>({name:a.name, initials:a.initials})),

    accDay: el("accDay").value,
    accMonth: el("accMonth").value,
    accYear: el("accYear").value,
    page: el("page").value,

    pubDay: el("pubDay").value,
    pubMonth: el("pubMonth").value,

    title: el("title").value,
    container: el("container").value,
    publisher: el("publisher").value,
    place: el("place").value,
    edition: el("edition").value,
    volume: el("volume").value,
    issue: el("issue").value,
    pages: el("pages").value,
    doi: el("doi").value,
    url: el("url").value,
    notes: el("notes").value,

    teachMedium: el("teachMedium").value,
    teachDay: el("teachDay").value,
    teachMonth: el("teachMonth").value,
    teachModule: el("teachModule").value,
    teachInstitution: el("teachInstitution").value,
    teachUnpub: el("teachUnpub").value,

    imgType: el("imgType").value,
    imgLocation: el("imgLocation").value,

    createdAt: new Date().toISOString()
  };
  f.yearSuffix = computeYearSuffix(f.id, f.authors, f.year);
  return f;
}

/* ============================================================
   WREXHAM OUTPUTS
   - In-text + Reference list entry
   ============================================================ */
function buildInText(f){
  const yearCore = safe(f.year) || "no date";
  const year = yearCore + (safe(f.yearSuffix) ? f.yearSuffix : "");
  const page = safe(f.page);
  const who = formatAuthorsInText(f.authors);

  if(f.secondary){
    const oa = safe(f.origAuthor) || "Unknown";
    const oy = safe(f.origYear) || "no date";
    const core = `(${oa}, ${oy}, cited by ${who}, ${year})`;
    return page ? core.replace(/\)$/, `, ${page})`) : core;
  }
  return page ? `(${who}, ${year}, ${page})` : `(${who}, ${year})`;
}

function formatReference(f){
  const cat = f.category;
  const authorsRef = formatAuthorsReference(f.authors);
  const yearCore = safe(f.year) || "no date";
  const year = yearCore + (safe(f.yearSuffix) ? f.yearSuffix : "");

  const title = safe(f.title);
  const container = safe(f.container);
  const place = safe(f.place);
  const publisher = safe(f.publisher);
  const edition = safe(f.edition);
  const volume = safe(f.volume);
  const issue = safe(f.issue);
  const pages = safe(f.pages);
  const doi = safe(f.doi);
  const url = safe(f.url);
  const acc = accessedBracket(f.accDay, f.accMonth, f.accYear);

  const tDay = ordinalDay(f.teachDay);
  const tMonth = normaliseMonth(f.teachMonth);
  const tModule = safe(f.teachModule);
  const tInst = safe(f.teachInstitution);
  const tUnpub = safe(f.teachUnpub)==="yes";

  const imgType = safe(f.imgType) || "Image";
  const imgLoc = safe(f.imgLocation);

  // BOOK
  if(cat==="book"){
    let s = `${authorsRef} (${year}), ${title || "Untitled"}.`;
    if(edition) s += ` ${edition}.`;
    if(place || publisher) s += ` ${place || "Place unknown"}: ${publisher || "Publisher unknown"}.`;
    return s.replace(/\s+/g," ").trim();
  }

  // EBOOK (online)
  if(cat==="ebook"){
    let s = `${authorsRef} (${year}), ${title || "Untitled"}.`;
    if(edition) s += ` ${edition}.`;
    if(place || publisher) s += ` ${place || "Place unknown"}: ${publisher || "Publisher unknown"}.`;
    if(url) s += ` Available from: ${url}.`;
    if(acc) s += ` ${acc}`;
    return s.replace(/\s+/g," ").trim();
  }

  // CHAPTER
  if(cat==="chapter"){
    let s = `${authorsRef} (${year}), ‘${title || "Untitled chapter"}’ in ${container || "Editor, A. (ed.), Title of Book"}.`;
    if(edition) s += ` ${edition}.`;
    if(place || publisher) s += ` ${place || "Place unknown"}: ${publisher || "Publisher unknown"}.`;
    if(pages) s += ` pp. ${pages}.`;
    return s.replace(/\s+/g," ").trim();
  }

  // JOURNAL
  if(cat==="journal"){
    let s = `${authorsRef} (${year}), ‘${title || "Untitled article"}’, ${container || "Journal title"},`;
    const bits = [];
    if(volume) bits.push(`Vol. ${volume}`);
    if(issue) bits.push(`No. ${issue}`);
    if(bits.length) s += ` ${bits.join(", ")},`;
    if(pages) s += ` pp. ${pages}.`;
    else s = s.replace(/,\s*$/,".");
    if(doi) s += ` DOI: ${doi}`;
    else if(url){
      s += ` Available from: ${url}.`;
      if(acc) s += ` ${acc}`;
      return s.replace(/\s+/g," ").trim();
    }
    if(!/[.!?]$/.test(s)) s += `.`;
    return s.replace(/\s+/g," ").trim();
  }

  // WEBSITE
  if(cat==="website"){
    let s = `${authorsRef} (${yearCore === "no date" ? "no date" : yearCore}), ${title || "Untitled"}.`;
    if(url) s += ` Available from: ${url}.`;
    if(acc) s += ` ${acc}`;
    return s.replace(/\s+/g," ").trim();
  }

  // LHB intranet
  if(cat==="lhb"){
    const auth = (authorsRef && authorsRef!=="Unknown") ? authorsRef : "Local Health Board – details withheld";
    const y = /^\d{4}$/.test(yearCore) ? yearCore : "no date";
    return `${auth} (${y}), ${title || "Untitled"} [intranet].`.replace(/\s+/g," ").trim();
  }

  // NEWSPAPER PRINT
  if(cat==="newspaper_print"){
    const d = ordinalDay(f.pubDay).replace(/(st|nd|rd|th)$/i,"") || "??";
    const m = normaliseMonth(f.pubMonth) || "??";
    const pbit = pages ? `p. ${pages.replace(/^p\.\s*/i,"")}.` : "";
    let s = `${authorsRef} (${yearCore}), ‘${title || "Untitled article"}’, ${container || "Newspaper"}, ${d} ${m}${pbit?`, ${pbit}`:"."}`;
    s = s.replace(/\s+/g," ").replace(/,\s*\./,".").trim();
    if(!/[.!?]$/.test(s)) s += ".";
    return s;
  }

  // NEWSPAPER ONLINE
  if(cat==="newspaper_online"){
    const d = ordinalDay(f.pubDay).replace(/(st|nd|rd|th)$/i,"") || "??";
    const m = normaliseMonth(f.pubMonth) || "??";
    let s = `${authorsRef} (${yearCore}), ‘${title || "Untitled article"}’, ${container || "Newspaper"}, ${d} ${m}.`;
    if(url) s += ` Available from: ${url}.`;
    if(acc) s += ` ${acc}`;
    return s.replace(/\s+/g," ").trim();
  }

  // GOVERNMENT PUB
  if(cat==="govpub"){
    let s = `${authorsRef} (${yearCore}), ${title || "Untitled"}.`;
    if(url) s += ` Available from: ${url}.`;
    if(acc) s += ` ${acc}`;
    return s.replace(/\s+/g," ").trim();
  }

  // LEGISLATION
  if(cat==="legislation"){
    let s = `${title || "Untitled Act"}. [Online].`;
    if(url) s += ` Available from: ${url}.`;
    if(acc) s += ` ${acc}`;
    return s.replace(/\s+/g," ").trim();
  }

  // RECORDED LECTURE
  if(cat==="lecture_recorded"){
    let s = `${authorsRef} (${yearCore}), ‘${title || "Untitled lecture"}’ [Lecture].`;
    if(tModule) s += ` ${tModule}.`;
    if(tInst) s += ` ${tInst}.`;
    if(tDay && tMonth) s += ` ${tDay.replace(/(st|nd|rd|th)$/i,"")} ${tMonth}.`;
    if(url) s += ` Available from: ${url}.`;
    if(acc) s += ` ${acc}`;
    return s.replace(/\s+/g," ").trim();
  }

  // LIVE LECTURE
  if(cat==="lecture_live"){
    let s = `${authorsRef} (${yearCore}), ‘${title || "Untitled lecture"}’ [Lecture].`;
    if(tModule) s += ` ${tModule}.`;
    if(tInst) s += ` ${tInst}.`;
    if(tDay && tMonth) s += ` ${tDay.replace(/(st|nd|rd|th)$/i,"")} ${tMonth}.`;
    return s.replace(/\s+/g," ").trim();
  }

  // HANDOUT
  if(cat==="handout"){
    let s = `${authorsRef} (${yearCore}), ‘${title || "Untitled handout"}’.`;
    if(tModule) s += ` ${tModule}.`;
    if(tInst) s += ` ${tInst}.`;
    s += ` Unpublished.`;
    return s.replace(/\s+/g," ").trim();
  }

  // PPT
  if(cat==="ppt"){
    let s = `${authorsRef} (${yearCore}), ‘${title || "Untitled presentation"}’ [PowerPoint presentation].`;
    if(tModule) s += ` ${tModule}.`;
    if(tInst) s += ` ${tInst}.`;
    if(url) s += ` Available from: ${url}.`;
    if(acc) s += ` ${acc}`;
    return s.replace(/\s+/g," ").trim();
  }

  // THESIS
  if(cat==="thesis"){
    let s = `${authorsRef} (${yearCore}), ${title || "Untitled"}.`;
    if(container) s += ` ${container}.`;
    if(url) s += ` Available from: ${url}.`;
    if(acc) s += ` ${acc}`;
    return s.replace(/\s+/g," ").trim();
  }

  // PERSONAL COMM
  if(cat==="personal_comm"){
    let s = `${authorsRef} (${yearCore}), ${title || "Subject"}.`;
    if(container) s += ` ${container}`;
    if(!/[.!?]$/.test(s)) s += `.`;
    return s.replace(/\s+/g," ").trim();
  }

  // IMAGE ONLINE
  if(cat==="image_online"){
    let s = `${authorsRef} (${yearCore}), ${title || "Untitled"} [${imgType}].`;
    if(url) s += ` Available from: ${url}.`;
    if(acc) s += ` ${acc}`;
    return s.replace(/\s+/g," ").trim();
  }

  // IMAGE LOCATION
  if(cat==="image_location"){
    let s = `${authorsRef} (${yearCore}), ${title || "Untitled"} [${imgType}].`;
    if(imgLoc) s += ` ${imgLoc}.`;
    return s.replace(/\s+/g," ").trim();
  }

  // FALLBACK
  let s = `${authorsRef} (${yearCore}), ${title || "Untitled"}.`;
  if(url) s += ` Available from: ${url}.`;
  if(acc) s += ` ${acc}`;
  return s.replace(/\s+/g," ").trim();
}

/* ============================================================
   LOCAL ITEMS + RENDERING
   ============================================================ */
let items = [];

function getAllItems(){ return items.slice(); }

function refreshLibrarySelect(){
  const sel = el("librarySelect");
  const libs = getLibList().map(sanitizeLibName).filter(Boolean).sort((a,b)=>a.localeCompare(b));
  const cur = getCurrentLib();
  sel.innerHTML = "";
  libs.forEach(name=>{
    const opt=document.createElement("option");
    opt.value=name; opt.textContent=name;
    if(name===cur) opt.selected=true;
    sel.appendChild(opt);
  });
}
function switchLibrary(name){
  setCurrentLib(name);
  refreshLibrarySelect();
  items = loadLocalItems();
  renderList();
  renderBib();
  clearForm();
}
el("librarySelect").onchange = (e)=>switchLibrary(e.target.value);

el("newLibraryBtn").onclick = ()=>{
  const name = sanitizeLibName(prompt("New library name:", "")||"");
  if(!name) return;
  const libs = getLibList().map(sanitizeLibName).filter(Boolean);
  if(!libs.includes(name)) libs.push(name);
  setLibList(libs);
  switchLibrary(name);
};

el("deleteLibraryBtn").onclick = ()=>{
  const cur = getCurrentLib();
  if(!confirm(`Delete library "${cur}"? This removes local data for this library.`)) return;
  localStorage.removeItem(KEY_PREFIX + cur);
  let libs = getLibList().map(sanitizeLibName).filter(Boolean).filter(x=>x!==cur);
  if(!libs.length) libs=["My Library"];
  setLibList(libs);
  switchLibrary(libs[0]);
};

el("clearLibBtn").onclick = ()=>{
  if(!confirm(`Clear ALL saved references in "${getCurrentLib()}"?`)) return;
  items = [];
  saveLocalItems(items);
  renderList();
  renderBib();
};

function clearForm(){
  editingId = null;
  el("modePill").textContent = "Mode: Add";
  el("secondaryToggle").checked=false;
  el("secondaryBox").classList.add("hide");
  el("origAuthor").value=""; el("origYear").value="";
  authorsState = [{name:"",initials:""}];
  renderAuthors();
  ["year","accDay","accMonth","accYear","page","pubDay","pubMonth","title","container","publisher","place","edition","volume","issue","pages","doi","url","notes",
   "teachDay","teachMonth","teachModule","teachInstitution","imgType","imgLocation"].forEach(id=>el(id).value="");
  el("category").value="website";
  updateConditionalFields();
  el("outIn").textContent="—";
  el("outRef").textContent="—";
  el("saveBtn").disabled=true;
  el("copyInBtn").disabled=true;
  el("copyRefBtn").disabled=true;
}
el("newBtn").onclick = clearForm;

el("secondaryToggle").onchange = ()=>{
  el("secondaryBox").classList.toggle("hide", !el("secondaryToggle").checked);
};

function generateOutputs(){
  fillAccessedTodayIfBlank();
  const f = snapshot();
  el("outIn").textContent = buildInText(f);
  el("outRef").textContent = formatReference(f);
  el("saveBtn").disabled=false;
  el("copyInBtn").disabled=false;
  el("copyRefBtn").disabled=false;
}
el("generateBtn").onclick = generateOutputs;

el("copyInBtn").onclick = ()=>navigator.clipboard.writeText(el("outIn").textContent);
el("copyRefBtn").onclick = ()=>navigator.clipboard.writeText(el("outRef").textContent);

function saveItem(){
  const f = snapshot();
  f.yearSuffix = computeYearSuffix(f.id, f.authors, f.year);

  if(!f.id){
    f.id = "local_" + Math.random().toString(16).slice(2);
    items.unshift(f);
  } else {
    const idx = items.findIndex(x=>x.id===f.id);
    if(idx>=0) items[idx]=f;
    else items.unshift(f);
  }
  saveLocalItems(items);
  renderList();
  renderBib();
  clearForm();
}
el("saveBtn").onclick = saveItem;

function humanCat(v){
  const map = {
    website:"Internet / webpage", journal:"Journal", book:"Book", chapter:"Chapter", ebook:"eBook",
    lhb:"Local Health Board policy", newspaper_print:"Newspaper (print)", newspaper_online:"Newspaper (online)",
    govpub:"Government publication", legislation:"Legislation", lecture_recorded:"Recorded lecture",
    lecture_live:"Live lecture", handout:"Tutor handout", ppt:"PowerPoint", thesis:"Thesis",
    personal_comm:"Personal comm", image_online:"Image (online)", image_location:"Image (location)", other:"Other"
  };
  return map[v] || v;
}

function renderList(){
  const q = safe(el("search").value).toLowerCase();
  const fc = el("filterCat").value;

  let filtered = items.slice();
  if(fc!=="all") filtered = filtered.filter(x=>x.category===fc);
  if(q){
    filtered = filtered.filter(x=>{
      const hay = [
        x.category, x.year, x.yearSuffix,
        (x.authors||[]).map(a=>a.name+" "+(a.initials||"")).join(" "),
        x.title, x.container, x.publisher, x.url, x.doi, x.notes
      ].join(" ").toLowerCase();
      return hay.includes(q);
    });
  }

  el("countPill").textContent = String(items.length);

  const list = el("list");
  list.innerHTML = "";
  if(!filtered.length){
    list.innerHTML = `<div class="hint">No items yet. Generate → Save on the left.</div>`;
    return;
  }

  filtered.forEach(it=>{
    // keep suffix stable
    if(!("yearSuffix" in it)) it.yearSuffix = computeYearSuffix(it.id, it.authors, it.year);

    const div = document.createElement("div");
    div.className="item";
    div.innerHTML = `
      <h4>${escapeHtml(it.title || "Untitled")} <span class="pill" style="margin-left:8px">${humanCat(it.category)}</span></h4>
      <div class="meta">
        <span>Authors: ${escapeHtml((it.authors||[]).map(a=>safe(a.name)).filter(Boolean).join(", ") || "Unknown")}</span>
        <span>Year: ${escapeHtml((safe(it.year)||"no date") + (safe(it.yearSuffix)||""))}</span>
        ${it.secondary ? `<span class="pill">Secondary</span>` : ``}
      </div>
      <div class="hint" style="margin-top:8px"><b>In-text:</b> ${escapeHtml(buildInText(it))}</div>
      <div class="hint"><b>Ref:</b> ${escapeHtml(formatReference(it))}</div>
      <div class="actions">
        <button class="btn" data-act="copyin">Copy in-text</button>
        <button class="btn" data-act="copyref">Copy ref</button>
        <button class="btn" data-act="edit">Edit</button>
        <button class="btn danger" data-act="del">Delete</button>
      </div>
    `;
    div.querySelector('[data-act="copyin"]').onclick = ()=>navigator.clipboard.writeText(buildInText(it));
    div.querySelector('[data-act="copyref"]').onclick = ()=>navigator.clipboard.writeText(formatReference(it));
    div.querySelector('[data-act="edit"]').onclick = ()=>loadToForm(it);
    div.querySelector('[data-act="del"]').onclick = ()=>{
      if(!confirm("Delete this source?")) return;
      items = items.filter(x=>x.id!==it.id);
      saveLocalItems(items);
      renderList();
      renderBib();
      if(editingId===it.id) clearForm();
    };
    list.appendChild(div);
  });
}
el("search").oninput = renderList;
el("filterCat").onchange = renderList;

function loadToForm(it){
  editingId = it.id;
  el("modePill").textContent = "Mode: Edit";

  el("category").value = it.category || "website";
  el("year").value = it.year || "";
  el("accDay").value = it.accDay || "";
  el("accMonth").value = it.accMonth || "";
  el("accYear").value = it.accYear || "";
  el("page").value = it.page || "";
  el("pubDay").value = it.pubDay || "";
  el("pubMonth").value = it.pubMonth || "";
  el("title").value = it.title || "";
  el("container").value = it.container || "";
  el("publisher").value = it.publisher || "";
  el("place").value = it.place || "";
  el("edition").value = it.edition || "";
  el("volume").value = it.volume || "";
  el("issue").value = it.issue || "";
  el("pages").value = it.pages || "";
  el("doi").value = it.doi || "";
  el("url").value = it.url || "";
  el("notes").value = it.notes || "";

  el("teachMedium").value = it.teachMedium || "Lecture";
  el("teachDay").value = it.teachDay || "";
  el("teachMonth").value = it.teachMonth || "";
  el("teachModule").value = it.teachModule || "";
  el("teachInstitution").value = it.teachInstitution || "";
  el("teachUnpub").value = it.teachUnpub || "no";

  el("imgType").value = it.imgType || "";
  el("imgLocation").value = it.imgLocation || "";

  el("secondaryToggle").checked = !!it.secondary;
  el("secondaryBox").classList.toggle("hide", !it.secondary);
  el("origAuthor").value = it.origAuthor || "";
  el("origYear").value = it.origYear || "";

  authorsState = (it.authors && it.authors.length) ? it.authors.map(a=>({name:a.name||"", initials:a.initials||""})) : [{name:"",initials:""}];
  renderAuthors();

  updateConditionalFields();

  // show outputs
  el("outIn").textContent = buildInText(it);
  el("outRef").textContent = formatReference(it);
  el("saveBtn").disabled = false;
  el("copyInBtn").disabled = false;
  el("copyRefBtn").disabled = false;

  window.scrollTo({top:0,behavior:"smooth"});
}

/* ============================================================
   BIBLIOGRAPHY VIEW + EXPORT
   ============================================================ */
function bibSortKey(it){
  const first = (it.authors && it.authors[0] && safe(it.authors[0].name)) ? safe(it.authors[0].name).toLowerCase() : "unknown";
  const year = (safe(it.year) || "no date") + (safe(it.yearSuffix) ? it.yearSuffix : "");
  const title = safe(it.title).toLowerCase();
  return `${first}||${year}||${title}`;
}
function buildBibText(){
  const sorted = items.slice().sort((a,b)=> bibSortKey(a).localeCompare(bibSortKey(b)));
  return sorted.length ? sorted.map(formatReference).join("\n") : "—";
}
function buildBibWordHtml(){
  const sorted = items.slice().sort((a,b)=> bibSortKey(a).localeCompare(bibSortKey(b)));
  if(!sorted.length) return "<p>—</p>";
  const paras = sorted.map(it=>{
    const ref = formatReference(it) || "";
    const safeRef = ref.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    return `<p style="margin:0 0 6pt 0; margin-left:36pt; text-indent:-36pt; font-family:Calibri, Arial, sans-serif; font-size:11pt;">${safeRef}</p>`;
  });
  return `<!doctype html><html><head><meta charset="utf-8"></head><body>${paras.join("")}</body></html>`;
}
async function copyHtmlToClipboard(html, fallbackText){
  try{
    if(navigator.clipboard && window.ClipboardItem){
      const item = new ClipboardItem({
        "text/html": new Blob([html], { type: "text/html" }),
        "text/plain": new Blob([fallbackText], { type: "text/plain" }),
      });
      await navigator.clipboard.write([item]);
      return;
    }
  } catch {}
  await navigator.clipboard.writeText(fallbackText);
}
function downloadFile(filename, text, mime){
  const blob = new Blob([text], {type: mime});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}
function renderBib(){
  el("bibOut").textContent = buildBibText();
}
el("copyBibBtn").onclick = ()=>navigator.clipboard.writeText(el("bibOut").textContent);
el("copyBibWordBtn").onclick = async ()=>{
  const txt = buildBibText();
  const html = buildBibWordHtml();
  await copyHtmlToClipboard(html, txt);
};
el("exportTxtBtn").onclick = ()=>{
  const stamp = new Date().toISOString().slice(0,10);
  downloadFile(`wrexham_reference_list_${getCurrentLib()}_${stamp}.txt`, buildBibText(), "text/plain;charset=utf-8");
};
el("exportDocBtn").onclick = ()=>{
  const stamp = new Date().toISOString().slice(0,10);
  downloadFile(`wrexham_reference_list_${getCurrentLib()}_${stamp}.doc`, buildBibWordHtml(), "application/msword;charset=utf-8");
};
el("exportCsvBtn").onclick = ()=>{
  const cols = [
    "id","category","year","yearSuffix","secondary","origAuthor","origYear",
    "authors","title","container","place","publisher","edition","volume","issue","pages","doi","url",
    "accDay","accMonth","accYear","pubDay","pubMonth","page","notes",
    "teachMedium","teachDay","teachMonth","teachModule","teachInstitution","teachUnpub",
    "imgType","imgLocation","createdAt"
  ];
  const esc = (v)=> `"${String(v??"").replace(/"/g,'""')}"`;
  const lines = [cols.join(",")];
  items.forEach(it=>{
    const row = {...it, authors: JSON.stringify(it.authors||[])};
    lines.push(cols.map(c=>esc(row[c])).join(","));
  });
  const stamp = new Date().toISOString().slice(0,10);
  downloadFile(`wrexham_refs_${getCurrentLib()}_${stamp}.csv`, lines.join("\n"), "text/csv;charset=utf-8");
};

/* ============================================================
   IMPORT: DOI + URL
   ============================================================ */
function detectInputType(raw){
  const s = safe(raw);
  if(!s) return {type:"empty", value:""};
  const doiMatch = s.match(/10\.\d{4,9}\/[-._;()/:A-Z0-9]+/i);
  if(doiMatch) return {type:"doi", value: doiMatch[0]};
  if(/^https?:\/\//i.test(s) || s.includes(".")) return {type:"url", value: s.startsWith("http")? s : "https://" + s};
  return {type:"unknown", value:s};
}
function setImportStatus(msg){ el("importStatus").textContent = msg; }

async function importFromDOI(doi){
  setImportStatus("Importing from DOI (Crossref)…");
  const res = await fetch(`https://api.crossref.org/works/${encodeURIComponent(doi)}`, { headers:{Accept:"application/json"}});
  if(!res.ok) throw new Error("Crossref failed");
  const data = await res.json();
  const m = data?.message;

  el("category").value = "journal";
  el("doi").value = doi;

  const title = Array.isArray(m?.title) ? m.title[0] : (m?.title || "");
  if(title) el("title").value = title;

  const journal = Array.isArray(m?.["container-title"]) ? m["container-title"][0] : (m?.["container-title"] || "");
  if(journal) el("container").value = journal;

  if(m?.volume) el("volume").value = m.volume;
  if(m?.issue) el("issue").value = m.issue;
  if(m?.page) el("pages").value = m.page;

  const pubYear =
    m?.issued?.["date-parts"]?.[0]?.[0] ||
    m?.published?.["date-parts"]?.[0]?.[0] ||
    m?.["published-online"]?.["date-parts"]?.[0]?.[0] || "";
  if(pubYear) el("year").value = String(pubYear);

  const link = m?.URL || (doi ? `https://doi.org/${doi}` : "");
  if(link) el("url").value = link;

  const arr = m?.author || [];
  if(Array.isArray(arr) && arr.length){
    authorsState = arr.slice(0, 15).map(a=>{
      const family = a.family || "";
      const given = a.given || "";
      const initials = given ? given.split(/\s+/).filter(Boolean).map(x=>x[0].toUpperCase()+".").join(" ") : "";
      return { name: family || given || "", initials };
    }).filter(x=>x.name);
    if(!authorsState.length) authorsState = [{name:"", initials:""}];
    renderAuthors();
  }

  fillAccessedTodayIfBlank();
  updateConditionalFields();
  setImportStatus("Imported. Edit anything → Generate → Save.");
}

async function importFromURL(url){
  setImportStatus("Importing from URL…");
  const prox = "https://r.jina.ai/http://" + url.replace(/^https?:\/\//i, "");
  const res = await fetch(prox);
  if(!res.ok) throw new Error("blocked");
  const text = await res.text();
  const doc = new DOMParser().parseFromString(text, "text/html");

  const pickMeta = (selectors)=>{
    for(const sel of selectors){
      const e = doc.querySelector(sel);
      const v = e?.getAttribute("content") || e?.textContent || "";
      if(v && v.trim()) return v.trim();
    }
    return "";
  };

  const title =
    pickMeta(['meta[property="og:title"]','meta[name="twitter:title"]','meta[name="citation_title"]']) ||
    (doc.querySelector("title")?.textContent || "").trim();

  const author =
    pickMeta(['meta[name="author"]','meta[property="article:author"]','meta[name="parsely-author"]','meta[name="citation_author"]']) ||
    pickMeta(['meta[property="og:site_name"]','meta[name="publisher"]','meta[name="dc.publisher"]']);

  el("category").value = "website";
  el("url").value = url;
  if(title) el("title").value = title;

  if(author){
    // crude: set as organisation (most common for policies)
    authorsState = [{name: author, initials:""}];
    renderAuthors();
  }

  const dateRaw = pickMeta([
    'meta[property="article:published_time"]',
    'meta[name="date"]',
    'meta[name="dc.date"]',
    'meta[name="dc.date.issued"]',
    'meta[name="DCTERMS.issued"]',
    'meta[name="citation_publication_date"]'
  ]);
  if(dateRaw){
    const m = String(dateRaw).match(/(\d{4})/);
    if(m) el("year").value = m[1];
  }

  fillAccessedTodayIfBlank();
  updateConditionalFields();
  setImportStatus("Imported. Edit anything → Generate → Save.");
}

el("importBtn").onclick = async ()=>{
  const raw = el("quickImport").value;
  const d = detectInputType(raw);
  el("importBtn").disabled = true;
  try{
    if(d.type==="doi") await importFromDOI(d.value);
    else if(d.type==="url") await importFromURL(d.value);
    else setImportStatus("Paste a DOI or full URL.");
  } catch {
    setImportStatus("Import failed (blocked). Fill manually for guaranteed accuracy.");
  } finally {
    el("importBtn").disabled = false;
  }
};

/* ============================================================
   PDF IMPORT
   ============================================================ */
try{
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.worker.min.js";
} catch {}

function setPdfStatus(msg){ el("pdfStatus").textContent = msg; }

function parsePdfYear(pdfDate){
  if(!pdfDate) return "";
  const s = String(pdfDate).replace(/^D:/,"");
  const y = s.slice(0,4);
  return /^\d{4}$/.test(y) ? y : "";
}
async function pdfFirstPageText(pdf){
  try{
    const page = await pdf.getPage(1);
    const content = await page.getTextContent();
    return content.items.map(i=>i.str).filter(Boolean).join(" ").replace(/\s+/g," ").trim().slice(0,2000);
  } catch { return ""; }
}
function orgDetect(url, text){
  const host = (()=>{ try{return new URL(url).hostname.toLowerCase();}catch{return "";} })();
  const s = (text||"").toLowerCase();
  if(/(^|\.)nice\.org\.uk$/.test(host) || /\bnice\b|national institute for health and care excellence/i.test(s)) return "NICE";
  if(/(^|\.)nhs\.uk$/.test(host) || /\bnhs\b|national health service/i.test(s)) return "NHS";
  if(/(^|\.)nmc\.org\.uk$/.test(host) || /\bnmc\b|nursing and midwifery council/i.test(s)) return "Nursing and Midwifery Council (NMC)";
  if(/(^|\.)gov\.uk$/.test(host) || /\buk government\b/i.test(s)) return "UK Government";
  if(/(^|\.)gov\.wales$/.test(host) || /\bwelsh government\b|\blywodraeth cymru\b/i.test(s)) return "Welsh Government";
  return "";
}
async function importPDF(file){
  setPdfStatus("Reading PDF…");
  try{
    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data:buf}).promise;
    const meta = await pdf.getMetadata().catch(()=>({info:{}}));
    const info = meta?.info || {};
    const firstText = await pdfFirstPageText(pdf);

    const title = (info.Title && String(info.Title).toLowerCase()!=="untitled")
      ? info.Title
      : (firstText.split(" ").slice(0,18).join(" ") || file.name.replace(/\.pdf$/i,""));
    if(title) el("title").value = title;

    const y = parsePdfYear(info.CreationDate || info.ModDate);
    if(y) el("year").value = y;

    // default category for PDFs is usually report/policy
    if(!safe(el("category").value)) el("category").value = "govpub";

    const url = safe(el("url").value);
    const org = orgDetect(url, firstText);
    if(org){
      authorsState = [{name: org, initials:""}];
      renderAuthors();
    } else if(info.Author){
      authorsState = [{name: info.Author, initials:""}];
      renderAuthors();
    }

    fillAccessedTodayIfBlank();
    updateConditionalFields();

    setPdfStatus("Loaded ✅ Edit details → Generate → Save.");
  } catch {
    setPdfStatus("Couldn’t read that PDF (encrypted/corrupt).");
  }
}

el("pickPdfBtn").onclick = ()=>el("pdfInput").click();
el("pdfInput").onchange = async (e)=>{
  const f = e.target.files?.[0];
  if(f) await importPDF(f);
  e.target.value="";
};
el("clearPdfBtn").onclick = ()=>setPdfStatus("PDF stays on your device. We extract metadata + scan page 1 for organisations.");

const drop = el("dropZone");
["dragenter","dragover"].forEach(ev=>drop.addEventListener(ev, e=>{e.preventDefault(); drop.classList.add("drag");}));
["dragleave","drop"].forEach(ev=>drop.addEventListener(ev, e=>{e.preventDefault(); drop.classList.remove("drag");}));
drop.addEventListener("drop", async (e)=>{
  const f = e.dataTransfer?.files?.[0];
  if(f && f.type==="application/pdf") await importPDF(f);
  else setPdfStatus("Drop a .pdf file.");
});

/* ============================================================
   SHARE + CLOUD (OPTIONAL)
   - Enabled only after Firebase config is set.
   ============================================================ */
let cloudEnabled = false;
let cloud = { auth:null, db:null, user:null, libraries:[], currentLibId:null };

function setAuthStatus(text, cls="status"){
  el("authStatus").textContent = text;
  el("authStatus").className = cls;
}
function setSavePill(){
  el("savePill").textContent = cloudEnabled && cloud.user ? "Storage: Cloud" : "Storage: Local";
}

el("enableCloudBtn").onclick = async ()=>{
  const raw = safe(el("firebaseConfigBox").value);
  if(!raw){ alert("Paste your Firebase config JSON first."); return; }
  try{
    const cfg = JSON.parse(raw);
    await enableFirebase(cfg);
    cloudEnabled = true;
    setAuthStatus("Cloud ready (sign in to use)", "status warn");
    setSavePill();
    alert("Cloud enabled. Now click Sign in.");
  } catch (e){
    alert("That config didn’t parse. Paste the exact Firebase config JSON object.");
  }
};

el("clearCloudBtn").onclick = ()=>{
  cloudEnabled = false;
  cloud = { auth:null, db:null, user:null, libraries:[], currentLibId:null };
  setAuthStatus("Cloud: off (local only)", "status");
  el("signInBtn").disabled = false;
  el("signOutBtn").disabled = true;
  setSavePill();
};

el("signInBtn").onclick = async ()=>{
  if(!cloudEnabled){ alert("To enable sign-in, paste your Firebase config in the landing page panel and click Enable cloud."); return; }
  if(!cloud.auth) { alert("Cloud not initialised. Click Enable cloud first."); return; }
  await cloudSignIn();
};
el("signOutBtn").onclick = async ()=>{
  if(cloud?.auth) await cloudSignOut();
};

el("syncBtn").onclick = async ()=>{
  if(cloudEnabled && cloud.user) await cloudSyncFromCloud();
  else alert("Sign in to sync cloud libraries. Local mode doesn’t need syncing.");
};

el("createShareBtn").onclick = async ()=>{
  if(!(cloudEnabled && cloud.user)) { alert("Sign in + cloud required for share links."); return; }
  const mode = el("shareMode").value;
  const link = await cloudCreateShareLink(mode);
  if(link){
    el("shareOut").textContent = link;
    el("copyShareBtn").disabled = false;
  }
};
el("copyShareBtn").onclick = ()=>navigator.clipboard.writeText(el("shareOut").textContent);

/* ---------- Firebase dynamic import & cloud logic ---------- */
async function enableFirebase(firebaseConfig){
  // dynamic ESM imports
  const appMod = await import("https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js");
  const authMod = await import("https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js");
  const fsMod = await import("https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js");

  const app = appMod.initializeApp(firebaseConfig);
  const auth = authMod.getAuth(app);
  const db = fsMod.getFirestore(app);
  const provider = new authMod.GoogleAuthProvider();

  cloud.auth = auth;
  cloud.db = db;
  cloud._mods = {authMod, fsMod, provider};

  authMod.onAuthStateChanged(auth, async (u)=>{
    cloud.user = u || null;
    el("signOutBtn").disabled = !cloud.user;
    el("signInBtn").disabled = !!cloud.user;
    setSavePill();

    if(cloud.user){
      setAuthStatus(`Signed in: ${cloud.user.email || "Google user"}`, "status ok");
      await cloudLoadLibraries();
      await cloudPickFirstLibrary();
      await cloudSyncFromCloud();
      // accept share link if present
      const params = new URLSearchParams(location.search);
      const shareId = params.get("share");
      if(shareId){
        await cloudAcceptShareLink(shareId);
        const u2 = new URL(location.href);
        u2.searchParams.delete("share");
        history.replaceState({}, "", u2.toString());
      }
    } else {
      setAuthStatus("Cloud ready (sign in to use)", "status warn");
      // fall back to local library
      refreshLibrarySelect();
      switchLibrary(getCurrentLib());
    }
  });
}

async function cloudSignIn(){
  const {authMod, provider} = cloud._mods;
  try{
    await authMod.signInWithPopup(cloud.auth, provider);
  } catch {
    alert("Sign-in failed. If popups are blocked on mobile, use Chrome.");
  }
}
async function cloudSignOut(){
  const {authMod} = cloud._mods;
  await authMod.signOut(cloud.auth);
}

async function cloudLoadLibraries(){
  const {fsMod} = cloud._mods;
  const libs = [];
  // libraries collection: {name, ownerUid, memberUids, members, deleted}
  const owned = await fsMod.getDocs(fsMod.query(fsMod.collection(cloud.db,"libraries"), fsMod.where("ownerUid","==", cloud.user.uid)));
  owned.forEach(d=>{ const data=d.data(); if(!data.deleted) libs.push({id:d.id, ...data}); });

  const member = await fsMod.getDocs(fsMod.query(fsMod.collection(cloud.db,"libraries"), fsMod.where("memberUids","array-contains", cloud.user.uid)));
  member.forEach(d=>{
    const data=d.data();
    if(data.deleted) return;
    if(!libs.find(x=>x.id===d.id)) libs.push({id:d.id, ...data});
  });

  libs.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
  cloud.libraries = libs;

  // render into selector
  const sel = el("librarySelect");
  sel.innerHTML = "";
  cloud.libraries.forEach(l=>{
    const opt=document.createElement("option");
    opt.value=l.id;
    opt.textContent = l.name + (l.ownerUid===cloud.user.uid ? " (you)" : "");
    sel.appendChild(opt);
  });
}

async function cloudPickFirstLibrary(){
  const {fsMod} = cloud._mods;
  if(!cloud.libraries.length){
    // create default
    const ref = await fsMod.addDoc(fsMod.collection(cloud.db,"libraries"),{
      name:"My Library",
      ownerUid: cloud.user.uid,
      memberUids: [],
      members: [],
      createdAt: fsMod.serverTimestamp()
    });
    await cloudLoadLibraries();
    cloud.currentLibId = ref.id;
  } else {
    cloud.currentLibId = cloud.libraries[0].id;
  }
  el("librarySelect").value = cloud.currentLibId;
}

function cloudCanEdit(lib){
  if(!lib || !cloud.user) return false;
  if(lib.ownerUid === cloud.user.uid) return true;
  const members = Array.isArray(lib.members) ? lib.members : [];
  const m = members.find(x=>x.uid===cloud.user.uid);
  return m?.role === "edit";
}

el("librarySelect").addEventListener("change", async (e)=>{
  const val = e.target.value;
  if(cloudEnabled && cloud.user){
    cloud.currentLibId = val;
    await cloudSyncFromCloud();
  } else {
    switchLibrary(val);
  }
});

el("newLibraryBtn").addEventListener("click", async ()=>{
  const name = sanitizeLibName(prompt("New library name:", "")||"");
  if(!name) return;

  if(cloudEnabled && cloud.user){
    const {fsMod} = cloud._mods;
    const ref = await fsMod.addDoc(fsMod.collection(cloud.db,"libraries"),{
      name,
      ownerUid: cloud.user.uid,
      memberUids: [],
      members: [],
      createdAt: fsMod.serverTimestamp()
    });
    await cloudLoadLibraries();
    cloud.currentLibId = ref.id;
    el("librarySelect").value = cloud.currentLibId;
    await cloudSyncFromCloud();
  } else {
    // local
    const libs = getLibList().map(sanitizeLibName).filter(Boolean);
    if(!libs.includes(name)) libs.push(name);
    setLibList(libs);
    switchLibrary(name);
  }
});

el("deleteLibraryBtn").addEventListener("click", async ()=>{
  if(cloudEnabled && cloud.user){
    const lib = cloud.libraries.find(l=>l.id===cloud.currentLibId);
    if(!lib) return;
    if(lib.ownerUid !== cloud.user.uid){
      alert("Only the library owner can delete a cloud library.");
      return;
    }
    if(!confirm(`Delete cloud library "${lib.name}"? (Soft delete)`)) return;
    const {fsMod} = cloud._mods;
    await fsMod.updateDoc(fsMod.doc(cloud.db,"libraries",cloud.currentLibId), {deleted:true, deletedAt: fsMod.serverTimestamp()});
    await cloudLoadLibraries();
    await cloudPickFirstLibrary();
    await cloudSyncFromCloud();
  } else {
    // local delete already wired above
  }
});

async function cloudSyncFromCloud(){
  const {fsMod} = cloud._mods;
  if(!cloud.currentLibId) return;

  const snap = await fsMod.getDocs(fsMod.collection(cloud.db,"libraries",cloud.currentLibId,"items"));
  const arr=[];
  snap.forEach(d=>arr.push({id:"cloud_"+d.id, ...d.data()}));
  arr.sort((a,b)=> (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));

  // keep yearSuffix stable on load if missing
  arr.forEach(it=>{
    if(!("yearSuffix" in it)) it.yearSuffix = computeYearSuffix(it.id, it.authors, it.year);
  });

  items = arr;
  renderList();
  renderBib();
  clearForm();
}

async function cloudSaveItem(it){
  const {fsMod} = cloud._mods;
  const lib = cloud.libraries.find(l=>l.id===cloud.currentLibId);
  if(!cloudCanEdit(lib)){
    alert("You have view-only access to this library.");
    return;
  }

  const clean = {...it};
  clean.yearSuffix = computeYearSuffix(clean.id, clean.authors, clean.year);

  if(clean.id && String(clean.id).startsWith("cloud_")){
    const id = String(clean.id).replace("cloud_","");
    await fsMod.setDoc(fsMod.doc(cloud.db,"libraries",cloud.currentLibId,"items",id), {...clean, updatedAt: fsMod.serverTimestamp()}, {merge:true});
  } else {
    const ref = await fsMod.addDoc(fsMod.collection(cloud.db,"libraries",cloud.currentLibId,"items"), {...clean, createdAt: fsMod.serverTimestamp(), updatedAt: fsMod.serverTimestamp()});
    clean.id = "cloud_"+ref.id;
  }
}

async function cloudCreateShareLink(role){
  const {fsMod} = cloud._mods;
  const lib = cloud.libraries.find(l=>l.id===cloud.currentLibId);
  if(!lib || lib.ownerUid !== cloud.user.uid){
    alert("Only the owner can create share links.");
    return null;
  }
  const shareRef = await fsMod.addDoc(fsMod.collection(cloud.db,"shareLinks"),{
    libId: cloud.currentLibId,
    role: role==="edit" ? "edit" : "view",
    createdAt: fsMod.serverTimestamp()
  });
  const url = new URL(location.href);
  url.searchParams.set("share", shareRef.id);
  return url.toString();
}

async function cloudAcceptShareLink(shareId){
  const {fsMod} = cloud._mods;
  const shareDoc = await fsMod.getDoc(fsMod.doc(cloud.db,"shareLinks",shareId));
  if(!shareDoc.exists()){ alert("Share link invalid or expired."); return; }
  const {libId, role} = shareDoc.data();
  const libDoc = await fsMod.getDoc(fsMod.doc(cloud.db,"libraries",libId));
  if(!libDoc.exists()){ alert("Library no longer exists."); return; }
  const lib = libDoc.data();
  if(lib.ownerUid !== cloud.user.uid){
    const memberUids = Array.isArray(lib.memberUids)? lib.memberUids : [];
    const members = Array.isArray(lib.members)? lib.members : [];
    if(!memberUids.includes(cloud.user.uid)){
      memberUids.push(cloud.user.uid);
      members.push({uid: cloud.user.uid, role: role==="edit" ? "edit" : "view"});
      await fsMod.updateDoc(fsMod.doc(cloud.db,"libraries",libId), {memberUids, members});
    }
  }
  await cloudLoadLibraries();
  cloud.currentLibId = libId;
  el("librarySelect").value = libId;
  await cloudSyncFromCloud();
  alert(role==="edit" ? "Joined library (can edit)." : "Joined library (view only).");
}

/* Hook cloud save into Save button */
const originalSave = saveItem;
el("saveBtn").onclick = async ()=>{
  generateOutputs(); // ensure outputs in sync
  const f = snapshot();
  f.yearSuffix = computeYearSuffix(f.id, f.authors, f.year);

  if(cloudEnabled && cloud.user){
    await cloudSaveItem(f);
    await cloudSyncFromCloud();
    clearForm();
  } else {
    originalSave();
  }
};

/* ============================================================
   INIT
   ============================================================ */
(function init(){
  ensureLocalLib();
  refreshLibrarySelect();
  items = loadLocalItems();
  renderAuthors();
  updateConditionalFields();
  fillAccessedTodayIfBlank();
  renderList();
  renderBib();

  // secondary UI
  el("secondaryBox").classList.add("hide");

  // share defaults
  el("createShareBtn").disabled = false;
  el("copyShareBtn").disabled = true;

  // cloud defaults
  setAuthStatus("Cloud: off (local only)", "status");
  setSavePill();
  el("signOutBtn").disabled = true;
})();
</script>
</body>
  </html>
